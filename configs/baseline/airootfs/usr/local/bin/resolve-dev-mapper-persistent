#!/usr/bin/bash

_resolve_dev_mapper_persistent() {
  local _cdrom="/dev/sr0" _loopdevice="/dev/loop$((3 * 1415))"
  if [ ! -e "${_mapper}" ]; then
      /usr/bin/losetup -rP "${_loopdevice}" "${_cdrom}"
  fi
}

_detach_dev_mapper_persistent() {
  local _mapper="/dev/mapper/persistent"
  local _cdrom="/dev/sr0" _loopdevice="" _mapperdevice=""
  _loopdevice=$(/usr/bin/losetup --list | /usr/bin/grep "${_cdrom}" | /usr/bin/awk '{ print $1 }')
  _mapperdevice=$(/usr/bin/losetup --list | /usr/bin/grep "loop.p4" | /usr/bin/awk '{ print $1 }')
  if [ "${_mapperdevice}" == "" ]; then
      if [ "${_loopdevice}" != "" ]; then
          /usr/bin/rm "${_mapper}" || true
          /usr/bin/losetup -d "${_loopdevice}" || true
      fi
  else
      echo "Unmount ${_mapperdevice} first!"
  fi
}

_main() {
    local _command="${1}"
    if [ "${_command}" == "start" ]; then
        _resolve_dev_mapper_persistent
    elif [ "${_command}" == "stop" ]; then
        _detach_dev_mapper_persistent
    fi
}

command="${1}"
_main "${command}"
